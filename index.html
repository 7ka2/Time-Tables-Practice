<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Time Tables Practice</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Load Inter font -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','sans-serif'] },
          colors: {
            'primary-blue': '#3b82f6',
            'secondary-green': '#10b981',
            'tertiary-yellow': '#f59e0b',
            'gem-purple': '#8B5CF6',
          }
        }
      }
    }
  </script>

  <style>
    body{ background:#f3f4f6; font-family:'Inter',sans-serif; }
    .card{ box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05); }
    .feedback{ transition:all .3s ease-in-out; }
    .correct{ background:#d1fae5; border-left:5px solid #10b981; }
    .incorrect{ background:#fee2e2; border-left:5px solid #ef4444; }
    input[type="number"]{ font-size:1.5rem; text-align:center; }
    .badge{ @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold; }
  </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-start justify-center">
  <div class="w-full max-w-3xl">
    <header class="text-center mb-8">
      <h1 class="text-4xl font-extrabold text-primary-blue mb-2">Multiplication Practice!</h1>
      <p class="text-xl text-gray-600">Choose your tables and get started.</p>
    </header>

    <div id="game-container" class="bg-white card rounded-2xl p-6 md:p-10">
      <!-- Config -->
      <section id="config-section" class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Which tables to practise?</h2>
        <div id="tables-grid" class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 lg:grid-cols-12 gap-3 mb-6"></div>
        <div id="config-buttons" class="flex justify-end space-x-2 mt-4"></div>

        <div class="mb-8 mt-8">
          <h3 class="text-2xl font-semibold text-gray-800 mb-4">Select Difficulty:</h3>
          <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
            <label for="difficulty-simple" id="label-simple" class="flex-1 flex items-center space-x-2 p-3 bg-blue-50 rounded-xl border-2 border-primary-blue transition-colors cursor-pointer hover:bg-blue-100">
              <input type="radio" name="difficulty" value="simple" id="difficulty-simple" checked class="text-primary-blue focus:ring-primary-blue h-5 w-5">
              <span class="font-semibold text-gray-800 text-lg">Simple (3 Options)</span>
            </label>
            <label for="difficulty-normal" id="label-normal" class="flex-1 flex items-center space-x-2 p-3 bg-white rounded-xl border-2 border-gray-300 transition-colors cursor-pointer hover:bg-gray-100">
              <input type="radio" name="difficulty" value="normal" id="difficulty-normal" class="text-primary-blue focus:ring-primary-blue h-5 w-5">
              <span class="font-semibold text-gray-800 text-lg">Normal (Type Answer)</span>
            </label>
          </div>
        </div>

        <button id="start-btn" class="w-full py-4 bg-secondary-green text-white font-extrabold text-xl rounded-xl hover:bg-green-600 transition-transform transform hover:scale-[1.01] shadow-lg">
          Start Practice!
        </button>
      </section>

      <!-- Game -->
      <section id="game-section" class="text-center hidden">
        <div class="mb-6 flex flex-col gap-3 sm:flex-row sm:justify-between sm:items-center bg-gray-100 p-4 rounded-xl">
          <div class="text-lg font-medium text-gray-600">
            Session Score: <span id="score-display" class="font-bold text-primary-blue text-2xl">0</span>
          </div>
          <div class="flex gap-2 justify-center">
            <button id="view-stats-btn" class="px-3 py-1 bg-primary-blue text-white rounded-lg hover:bg-blue-600 transition">View Stats</button>
            <button id="reset-btn" class="px-3 py-1 bg-tertiary-yellow text-white rounded-lg hover:bg-yellow-600 transition">New Selection</button>
          </div>
        </div>

        <p class="text-3xl md:text-5xl font-extrabold text-gray-900 mb-8" id="question-text">5 &times; 8 = ?</p>

        <div id="normal-input" class="flex flex-col sm:flex-row gap-4 items-center justify-center">
          <input type="number" id="answer-input" placeholder="Your Answer" class="w-full sm:w-1/2 p-4 border-4 border-gray-300 rounded-xl focus:border-primary-blue focus:ring-primary-blue outline-none" inputmode="numeric">
          <button id="submit-btn" class="w-full sm:w-auto px-8 py-4 bg-primary-blue text-white font-extrabold text-xl rounded-xl hover:bg-blue-600 transition-transform transform hover:scale-[1.01] shadow-lg">
            Submit
          </button>
        </div>

        <div id="simple-options" class="grid grid-cols-1 sm:grid-cols-3 gap-4 hidden"></div>

        <div id="feedback-message" aria-live="polite" class="feedback mt-6 p-4 rounded-xl text-left text-lg font-semibold min-h-[60px] flex items-center justify-center" style="opacity:0;"></div>
      </section>
    </div>

    <!-- Stats Panel -->
    <section id="stats-section" class="bg-white card rounded-2xl p-6 md:p-8 mt-6 hidden">
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4 mb-4">
        <div>
          <h2 class="text-2xl font-bold text-gray-800">Player Progress</h2>
          <p class="text-gray-600">Accuracy per table and highlights for today and overall.</p>
        </div>
        <div class="flex gap-2">
          <button id="tab-today" class="px-3 py-2 rounded-lg border-2 border-primary-blue text-primary-blue font-semibold">Today</button>
          <button id="tab-overall" class="px-3 py-2 rounded-lg border-2 border-gray-300 text-gray-700">Allâ€‘time</button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="p-4 rounded-xl bg-blue-50 border border-blue-200">
          <div class="text-sm text-gray-600">Overall Accuracy</div>
          <div class="text-3xl font-extrabold text-primary-blue" id="overall-acc">â€”</div>
          <div class="text-sm text-gray-600" id="overall-attempts">â€” attempts</div>
        </div>
        <div class="p-4 rounded-xl bg-green-50 border border-green-200">
          <div class="text-sm text-gray-600">Best Known Tables</div>
          <div class="mt-1 flex flex-wrap gap-2" id="best-tables"></div>
        </div>
        <div class="p-4 rounded-xl bg-red-50 border border-red-200">
          <div class="text-sm text-gray-600">Needs Practice</div>
          <div class="mt-1 flex flex-wrap gap-2" id="weak-tables"></div>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="tables-stats-grid">
        <!-- per-table cards injected here -->
      </div>

      <div class="mt-6 flex gap-2 justify-end">
        <button id="close-stats" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300">Close</button>
        <button id="reset-stats" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Reset All Stats</button>
      </div>
    </section>
  </div>

  <!-- Game Logic (no Gemini) -->
  <script type="module">
    // ------ State ------
    let score = 0;
    let tableOptions = [];
    let currentQuestion = { factor1: 0, factor2: 0, answer: 0 };
    let isGameRunning = false;
    let difficulty = 'simple';

    // Elements
    const configSection = document.getElementById('config-section');
    const gameSection = document.getElementById('game-section');
    const scoreDisplay = document.getElementById('score-display');
    const questionText = document.getElementById('question-text');
    const answerInput = document.getElementById('answer-input');
    const feedbackMessage = document.getElementById('feedback-message');
    const normalInputDiv = document.getElementById('normal-input');
    const simpleOptionsDiv = document.getElementById('simple-options');
    const tablesGrid = document.getElementById('tables-grid');
    const configButtons = document.getElementById('config-buttons');

    // Stats elements
    const statsSection = document.getElementById('stats-section');
    const tabToday = document.getElementById('tab-today');
    const tabOverall = document.getElementById('tab-overall');
    const overallAcc = document.getElementById('overall-acc');
    const overallAttempts = document.getElementById('overall-attempts');
    const bestTables = document.getElementById('best-tables');
    const weakTables = document.getElementById('weak-tables');
    const tablesStatsGrid = document.getElementById('tables-stats-grid');

    // Buttons
    const startBtn = document.getElementById('start-btn');
    const resetBtn = document.getElementById('reset-btn');
    const submitBtn = document.getElementById('submit-btn');
    const viewStatsBtn = document.getElementById('view-stats-btn');
    const closeStatsBtn = document.getElementById('close-stats');
    const resetStatsBtn = document.getElementById('reset-stats');

    // ------ Stats persistence (localStorage) ------
    const STORAGE_KEY = 'tt_stats_v1';

    function todayKey(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }

    function loadStats(){
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { overall:initEmptyStats(), daily:{} }; }
      catch { return { overall:initEmptyStats(), daily:{} }; }
    }

    function saveStats(stats){ localStorage.setItem(STORAGE_KEY, JSON.stringify(stats)); }

    function initEmptyStats(){
      const perTable = {};
      for (let t=1; t<=12; t++) perTable[t] = { correct:0, total:0 };
      return { perTable, totalCorrect:0, totalAttempts:0 };
    }

    function getViewStats(view){
      const stats = loadStats();
      if (view === 'today'){
        const key = todayKey();
        return stats.daily[key] ? stats.daily[key] : initEmptyStats();
      } else {
        return stats.overall || initEmptyStats();
      }
    }

    function recordAttempt(table, wasCorrect){
      const stats = loadStats();
      // overall
      ensureStats(stats);
      stats.overall.totalAttempts++;
      stats.overall.perTable[table].total++;
      if (wasCorrect){ stats.overall.totalCorrect++; stats.overall.perTable[table].correct++; }
      // daily
      const key = todayKey();
      if (!stats.daily[key]) stats.daily[key] = initEmptyStats();
      stats.daily[key].totalAttempts++;
      stats.daily[key].perTable[table].total++;
      if (wasCorrect){ stats.daily[key].totalCorrect++; stats.daily[key].perTable[table].correct++; }
      saveStats(stats);
    }

    function ensureStats(stats){
      if (!stats.overall) stats.overall = initEmptyStats();
      for (let t=1;t<=12;t++){
        if (!stats.overall.perTable[t]) stats.overall.perTable[t] = {correct:0,total:0};
      }
    }

    function pct(correct, total){ return total ? Math.round((correct/total)*100) : 0; }

    // ------ Build Config UI ------
    function setupConfigElements() {
      const frag = document.createDocumentFragment();
      for (let i = 1; i <= 12; i++) {
        const div = document.createElement('div');
        div.className = "flex items-center justify-center";
        const input = document.createElement('input');
        input.type = "checkbox"; input.id = `table-${i}`; input.value = i; input.checked = i <= 10; input.className = "hidden peer";
        const label = document.createElement('label');
        label.htmlFor = `table-${i}`; label.textContent = i;
        label.className = "cursor-pointer w-full h-10 flex items-center justify-center font-bold text-lg rounded-xl transition-all duration-200 border-2 border-primary-blue text-primary-blue bg-white peer-checked:bg-primary-blue peer-checked:text-white hover:shadow-md";
        div.append(input,label); frag.appendChild(div);
      }
      tablesGrid.appendChild(frag);

      const selectAllBtn = document.createElement('button');
      selectAllBtn.textContent = 'Select All';
      selectAllBtn.className = 'px-4 py-2 bg-secondary-green text-white font-medium rounded-lg hover:bg-green-600 transition';
      selectAllBtn.addEventListener('click', () => document.querySelectorAll('#tables-grid input[type="checkbox"]').forEach(cb => cb.checked = true));

      const deselectAllBtn = document.createElement('button');
      deselectAllBtn.textContent = 'Deselect All';
      deselectAllBtn.className = 'px-4 py-2 bg-gray-400 text-white font-medium rounded-lg hover:bg-gray-500 transition';
      deselectAllBtn.addEventListener('click', () => document.querySelectorAll('#tables-grid input[type="checkbox"]').forEach(cb => cb.checked = false));

      configButtons.append(deselectAllBtn, selectAllBtn);
    }

    function setupEventListeners() {
      document.addEventListener('keydown', (event) => {
        if (isGameRunning && difficulty === 'normal' && event.key === 'Enter') {
          event.preventDefault();
          checkAnswer();
        }
      });

      document.querySelectorAll('input[name="difficulty"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          document.getElementById('label-simple').classList.remove('border-primary-blue','bg-blue-50');
          document.getElementById('label-normal').classList.remove('border-primary-blue','bg-blue-50');
          document.getElementById('label-simple').classList.add('border-gray-300','bg-white');
          document.getElementById('label-normal').classList.add('border-gray-300','bg-white');
          const label = document.querySelector(`label[for="${e.target.id}"]`);
          label.classList.add('border-primary-blue','bg-blue-50');
          label.classList.remove('border-gray-300','bg-white');
        });
      });

      startBtn?.addEventListener('click', startGame);
      resetBtn?.addEventListener('click', resetGame);
      submitBtn?.addEventListener('click', checkAnswer);
      viewStatsBtn?.addEventListener('click', () => { statsSection.classList.remove('hidden'); renderStats('today'); });
      closeStatsBtn?.addEventListener('click', () => statsSection.classList.add('hidden'));
      resetStatsBtn?.addEventListener('click', resetAllStats);
      tabToday?.addEventListener('click', () => renderStats('today'));
      tabOverall?.addEventListener('click', () => renderStats('overall'));
    }

    // ------ Game core ------
    function startGame() {
      tableOptions = [];
      document.querySelectorAll('#tables-grid input[type="checkbox"]:checked').forEach(cb => tableOptions.push(parseInt(cb.value, 10)));
      difficulty = document.querySelector('input[name="difficulty"]:checked')?.value || 'normal';

      if (!tableOptions.length) {
        showFeedback("Oops! Please select at least one times table to practise.", 'incorrect', 3000);
        return;
      }

      score = 0; scoreDisplay.textContent = score; isGameRunning = true;
      configSection.classList.add('hidden'); gameSection.classList.remove('hidden');

      if (difficulty === 'simple') { normalInputDiv.classList.add('hidden'); simpleOptionsDiv.classList.remove('hidden'); }
      else { simpleOptionsDiv.classList.add('hidden'); normalInputDiv.classList.remove('hidden'); answerInput.value=''; answerInput.focus({ preventScroll:true }); }

      showFeedback(`Let's go! Ready for the first question.`, 'correct', 1200);
      generateQuestion();
    }

    function resetGame() {
      isGameRunning = false; configSection.classList.remove('hidden'); gameSection.classList.add('hidden');
      feedbackMessage.style.opacity = '0'; answerInput.value = ''; score = 0; scoreDisplay.textContent = score; questionText.textContent = '...';
      document.activeElement?.blur();
    }

    function generateQuestion() {
      const factor2 = tableOptions[Math.floor(Math.random() * tableOptions.length)];
      const factor1 = Math.floor(Math.random() * 12) + 1;
      currentQuestion = { factor1, factor2, answer: factor1 * factor2 };
      questionText.textContent = `${factor1} Ã— ${factor2} = ?`;

      if (difficulty === 'simple') { generateMultipleChoiceOptions(currentQuestion.answer); }
      else { answerInput.value = ''; answerInput.focus({ preventScroll:true }); }
    }

    function processAnswer(userAnswer) {
      const wasCorrect = (userAnswer === currentQuestion.answer);
      if (wasCorrect) { score++; showFeedback(`Correct! ðŸŽ‰ ${currentQuestion.factor1} Ã— ${currentQuestion.factor2} is ${currentQuestion.answer}.`, 'correct', 1200); }
      else { score = Math.max(0, score - 1); showFeedback(`Not quite! ðŸ˜“ ${currentQuestion.factor1} Ã— ${currentQuestion.factor2} is actually ${currentQuestion.answer}.`, 'incorrect', 2000); }
      scoreDisplay.textContent = score;
      // record stats
      recordAttempt(currentQuestion.factor2, wasCorrect);
      generateQuestion();
    }

    function checkAnswer() {
      if (!isGameRunning || difficulty === 'simple') return;
      const val = answerInput.value.trim();
      if (val === '') { showFeedback("Please enter a number!", 'incorrect', 1200); return; }
      const userAnswer = parseInt(val, 10);
      if (Number.isNaN(userAnswer)) { showFeedback("Please enter a valid number!", 'incorrect', 1200); return; }
      processAnswer(userAnswer);
    }

    function showFeedback(message, type, duration = 1800) {
      feedbackMessage.classList.remove('correct','incorrect');
      feedbackMessage.textContent = message; feedbackMessage.classList.add(type); feedbackMessage.style.opacity = '1';
      window.clearTimeout(showFeedback._t);
      showFeedback._t = window.setTimeout(() => { feedbackMessage.style.opacity = '0'; setTimeout(() => feedbackMessage.classList.remove('correct','incorrect'), 250); }, duration);
    }

    function shuffleArray(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a; }

    function generateDistractors(correct) {
      const s = new Set(); const minVal = Math.max(1, correct - 10); const maxVal = correct + 10;
      while (s.size < 2) { const d = Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal; if (d !== correct && Math.abs(d - correct) >= (correct > 10 ? 3 : 1)) s.add(d); }
      return [...s];
    }

    function generateMultipleChoiceOptions(correctAnswer) {
      simpleOptionsDiv.innerHTML = '';
      const options = shuffleArray([correctAnswer, ...generateDistractors(correctAnswer)]);
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.textContent = opt; btn.value = opt; btn.className = "py-4 px-6 bg-primary-blue text-white font-extrabold text-2xl rounded-xl hover:bg-blue-600 transition-transform transform hover:scale-[1.03] shadow-lg";
        btn.addEventListener('click', () => processAnswer(parseInt(btn.value,10)));
        simpleOptionsDiv.appendChild(btn);
      });
    }

    // ------ Stats UI ------
    function renderStats(view){
      // Toggle tabs styles
      if (view==='today'){
        tabToday.className = 'px-3 py-2 rounded-lg border-2 border-primary-blue text-primary-blue font-semibold';
        tabOverall.className = 'px-3 py-2 rounded-lg border-2 border-gray-300 text-gray-700';
      } else {
        tabOverall.className = 'px-3 py-2 rounded-lg border-2 border-primary-blue text-primary-blue font-semibold';
        tabToday.className = 'px-3 py-2 rounded-lg border-2 border-gray-300 text-gray-700';
      }

      const data = getViewStats(view);
      const acc = pct(data.totalCorrect, data.totalAttempts);
      overallAcc.textContent = `${acc}%`;
      overallAttempts.textContent = `${data.totalAttempts} attempt${data.totalAttempts===1?'':'s'}`;

      // compute best & weak tables
      const tableArr = [];
      for (let t=1;t<=12;t++){
        const {correct,total} = data.perTable[t];
        tableArr.push({ t, correct, total, acc: pct(correct,total) });
      }

      const attempted = tableArr.filter(x=>x.total>0);
      const thresholdAttempts = 5; // only consider as "best" if enough attempts
      const best = attempted.filter(x=>x.total>=thresholdAttempts).sort((a,b)=>b.acc-a.acc).slice(0,3);
      const weak = tableArr.slice().sort((a,b)=>a.acc-b.acc || a.total-b.total).slice(0,3);

      bestTables.innerHTML = best.length? best.map(x=>badge(x.t, 'good')).join(' ') : '<span class="text-gray-600">Practise a bit more to reveal your strengths.</span>';
      weakTables.innerHTML = weak.map(x=>badge(x.t, 'bad')).join(' ');

      // grid cards
      tablesStatsGrid.innerHTML = '';
      tableArr.forEach(x=> tablesStatsGrid.appendChild(tableCard(x)) );
    }

    function badge(n, type){
      const base = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold';
      const cls = type==='good' ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200';
      return `<span class="${base} ${cls}">Ã—${n}</span>`;
    }

    function tableCard({t, correct, total, acc}){
      const wrap = document.createElement('div');
      const barPct = acc;
      wrap.className = 'p-4 rounded-xl border ' + (acc>=80? 'border-green-300 bg-green-50':'border-gray-200 bg-white');
      wrap.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <div class="text-lg font-bold">Ã—${t}</div>
          <div class="text-sm text-gray-600">${total} attempt${total===1?'':'s'}</div>
        </div>
        <div class="text-2xl font-extrabold ${acc>=80?'text-green-700':'text-gray-800'}">${acc}%</div>
        <div class="w-full h-3 bg-gray-200 rounded mt-3 overflow-hidden">
          <div class="h-3 bg-primary-blue" style="width:${barPct}%;"></div>
        </div>
        <div class="text-sm text-gray-600 mt-2">${correct} correct</div>
      `;
      return wrap;
    }

    function resetAllStats(){
      if (!confirm('Reset all saved progress?')) return;
      localStorage.removeItem(STORAGE_KEY);
      renderStats('today');
    }

    // ------ Init ------
    document.addEventListener('DOMContentLoaded', () => {
      setupConfigElements();
      setupEventListeners();
      // Prep initial stats panel values
      renderStats('today');
    });
  </script>
</body>
</html>
